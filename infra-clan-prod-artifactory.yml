---
# This playbook is only needed for the commercial lan server
# Once this completes there are a few manual steps that will currently need to be run
# See docs/infra-clan-prod-artifactory for more information

- import_playbook: infra-clan-prod.yml

- name: Set up Artifactory
  hosts: infra-clan-prod-artifactory
  become: true
  become_method: sudo
  become_user: root
  gather_facts: true

  roles:
    - teaming
    - nginx
    - postgresql
    - artifactory

- name: Set up CLAN system for artifactory
  hosts: infra-clan-prod-artifactory
  become: True
  gather_facts: true

  handlers:
    - name: restart nfs
      service: name=nfs-server state=restarted

    - name: restart firewalld
      service: name=firewalld state=restarted

  roles:
    - ansible-role-nfs

  tasks:
    - name: Install a clan packages (this will take a few minutes)
      yum:
        name: "{{ item }}"
        state: present
      with_items:
        - "@^graphical-server-environment"
        - virt-install
        - libguestfs-tools
        - virt-manager

    - name: Enable and start service
      service:
        name: "{{ item }}"
        enabled: yes
        state: started
      with_items:
        - nfs-server
        - rpcbind
        - libvirtd

    - name: Create export dir
      file:
        path: "/var/opt/jfrog/rh-repos"
        state: directory
        mode: 0777

    - name: Set the target to graphical
      command: systemctl set-default graphical.target

    - name: Open rpc-bind ports in the firewall
      firewalld:
        service: "{{ item }}"
        permanent: true
        immediate: true
        state: enabled
      with_items:
        - rpc-bind
        - mountd
        - nfs
      notify: restart firewalld

    - name: Add virbr0 to firewall for NFS
      firewalld:
        interface: virbr0
        permanent: true
        immediate: true
        state: enabled
      notify: restart firewalld
...
